name: Copilot + Unity MCP + Tests

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
  pull_request:

jobs:
  unity-copilot-and-tests:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write          # needed for test results
      actions: read          # optional, for artifacts

    steps:
      # ────────────────────────────── Checkout ──────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      # ─────────────────────── Free disk space (important) ───────────────────────
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc "/usr/local/share/boost" "$AGENT_TOOLSDIRECTORY" || true

      # ─────────────────────── Validate Unity credentials ───────────────────────
      - name: Validate Unity credentials
        env:
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        run: |
          if [[ -z "$UNITY_EMAIL" || -z "$UNITY_PASSWORD" ]]; then
            echo "ERROR: Add UNITY_EMAIL and UNITY_PASSWORD secrets!"
            exit 1
          fi
          echo "Unity account ready"

      # ─────────────────────── Create working docker-compose.yml ───────────────────────
      - name: Create docker-compose.yml
        env:
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        run: |
          cat > docker-compose.yml << EOF
          services:
            unity-mcp-server:
              image: ivanmurzakdev/unity-mcp-server:latest
              container_name: unity-mcp-server
              ports:
                - "8080:8080"
              environment:
                UNITY_MCP_PORT: 8080
                UNITY_MCP_CLIENT_TRANSPORT: http
                UNITY_EMAIL: ${UNITY_EMAIL}
                UNITY_PASSWORD: ${UNITY_PASSWORD}
              healthcheck:
                test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
                interval: 8s
                timeout: 5s
                retries: 50
                start_period: 10s
              restart: unless-stopped

            unity-editor:
              image: unityci/editor:ubuntu-6000.0.12f1-base-3
              container_name: unity-editor
              ports:
                - "7777:7777"
              shm_size: 4g
              environment:
                UNITY_EMAIL: ${UNITY_EMAIL}
                UNITY_PASSWORD: ${UNITY_PASSWORD}
              volumes:
                - ./Unity-MCP-Plugin:/project
                - unity-logs:/project/Logs
              entrypoint: ["/bin/bash", "-c"]
              command: |
                set -e
                /opt/unity/Editor/Unity -batchmode -nographics -quit -returnlicense || true
                /opt/unity/Editor/Unity \\
                  -batchmode -nographics -quit \\
                  -username "\${UNITY_EMAIL}" \\
                  -password "\${UNITY_PASSWORD}" \\
                  -logFile /tmp/license.log
                mkdir -p /project/{Assets,ProjectSettings,Logs}
                chmod 777 /project/Logs
                exec /opt/unity/Editor/Unity \\
                  -projectPath /project \\
                  -batchmode -nographics \\
                  -executeMethod com.IvanMurzak.Unity.MCP.Editor.Startup.Init \\
                  -logFile /project/Logs/unity.log

          volumes:
            unity-logs:
          EOF

      # ─────────────────────── Start Copilot + Unity Environment ───────────────────────
      - name: Start Unity + MCP Server
        run: |
          docker compose up -d
          docker compose ps

      - name: Wait for MCP Server
        run: |
          for i in {1..60}; do
            if curl -f http://localhost:8080/health >/dev/null 2>&1; then
              echo "MCP Server is healthy!"
              break
            fi
            sleep 5
          done
          curl -f http://localhost:8080/health || (docker compose logs unity-mcp-server && exit 1)

      - name: Wait for Unity Editor
        run: |
          for i in {1..80}; do
            if docker exec unity-editor pgrep -f Unity >/dev/null 2>&1; then
              echo "Unity Editor is running!"
              break
            fi
            sleep 6
          done

      - name: Success – Copilot Environment Ready
        run: |
          echo "COPILOT + UNITY IS READY — http://localhost:8080"

      # ─────────────────────── Run Unity Tests (Personal License – 2025 method) ───────────────────────
      - name: Run Unity Tests
        uses: game-ci/unity-test-runner@v4
        env:
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          projectPath: Unity-MCP-Plugin
          unityVersion: 6000.0.12f1
          checkName: "Unity Test Results"
          githubToken: ${{ secrets.GITHUB_TOKEN }}   # needed to upload results

      # ─────────────────────── Optional: Test MCP endpoint (proof it works) ───────────────────────
      - name: Test MCP Connection
        run: |
          curl -X POST http://localhost:8080/v1/messages \
            -H "Content-Type: application/json" \
            -d '{"messages":[{"role":"user","content":"Hello from GitHub Actions test run!"}]}' \
            -s | jq .

      # ─────────────────────── Cleanup ───────────────────────
      - name: Cleanup
        if: always()
        run: |
          docker compose down -v || true
          echo "All cleaned up"