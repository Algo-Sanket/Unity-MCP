name: "Copilot Setup Steps"
on:
  workflow_dispatch:
  push:
    paths: [ .github/workflows/copilot-setup-steps.yml ]
  pull_request:
    paths: [ .github/workflows/copilot-setup-steps.yml ]

jobs:
  copilot-setup-steps:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    # GitHub Services - these run as sidecars throughout the entire job
    services:
      unity-editor:
        image: unityci/editor:ubuntu-2022.3.61f1-base-3
        ports:
          - 7777:7777
        options: >-
          --name unity-editor
          --shm-size=2g
      
      unity-mcp-server:
        image: ivanmurzakdev/unity-mcp-server:latest
        ports:
          - 8080:8080
        env:
          UNITY_MCP_PORT: 8080
          UNITY_MCP_CLIENT_TRANSPORT: http
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Wait for services to be ready
        run: |
          echo "Waiting for service containers to be ready..."
          sleep 10
          docker ps
      
      - name: Prepare Unity container
        run: |
          echo "Setting up Unity license and project..."
          
          # Create license directory
          docker exec unity-editor mkdir -p /root/.local/share/unity3d/Unity
          
          # Create license file
          docker exec unity-editor bash -c "cat > /root/.local/share/unity3d/Unity/Unity_v2022.x.ulf << 'EOF'
          ${{ secrets.UNITY_LICENSE }}
          EOF"
          
          # Verify license
          docker exec unity-editor ls -lh /root/.local/share/unity3d/Unity/Unity_v2022.x.ulf
          
          # Prepare log directory
          docker exec unity-editor mkdir -p /project/Logs
          docker exec unity-editor chmod 777 /project/Logs
          
          echo "✓ Unity container prepared"
      
      - name: Create Unity launch script
        run: |
          docker exec unity-editor bash -c 'cat > /tmp/launch-unity.sh << "LAUNCH_EOF"
          #!/bin/bash
          set -x
          echo "=== Unity Launch Script ==="
          echo "Project: /project"
          ls -la /project/ 2>&1
          
          /opt/unity/Editor/Unity \
            -projectPath /project \
            -batchmode \
            -nographics \
            -executeMethod com.IvanMurzak.Unity.MCP.Editor.Startup.Init \
            -logFile /project/Logs/unity.log \
            2>&1 | tee /project/Logs/unity-stdout.log
          
          echo "Unity exited with code: $?"
          LAUNCH_EOF'
          
          docker exec unity-editor chmod +x /tmp/launch-unity.sh
      
      - name: Launch Unity in background
        run: |
          echo "Starting Unity Editor..."
          docker exec -d unity-editor bash -c '/tmp/launch-unity.sh > /project/Logs/launch.log 2>&1 &'
          sleep 5
      
      - name: Verify Unity process
        run: |
          echo "Checking Unity process..."
          if docker exec unity-editor pgrep -f "Unity" > /dev/null; then
            echo "✓ Unity is running!"
            docker exec unity-editor ps aux | grep Unity | grep -v grep
          else
            echo "✗ Unity not running!"
            docker exec unity-editor cat /project/Logs/launch.log || echo "No launch log"
            exit 1
          fi
      
      - name: Wait for Unity initialization
        run: |
          echo "Monitoring Unity initialization..."
          TIMEOUT=300
          ELAPSED=0
          
          while [ $ELAPSED -lt $TIMEOUT ]; do
            # Check process still alive
            if ! docker exec unity-editor pgrep -f "Unity" > /dev/null; then
              echo "✗ Unity process died!"
              docker exec unity-editor cat /project/Logs/unity.log || echo "No log"
              exit 1
            fi
            
            # Check log file
            if docker exec unity-editor test -f /project/Logs/unity.log; then
              SIZE=$(docker exec unity-editor stat -c%s /project/Logs/unity.log 2>/dev/null || echo "0")
              echo "Log size: $SIZE bytes (${ELAPSED}s)"
              
              # Show progress every 30s
              if [ $((ELAPSED % 30)) -eq 0 ] && [ $SIZE -gt 0 ]; then
                docker exec unity-editor tail -15 /project/Logs/unity.log
              fi
              
              # Check for completion markers
              if docker exec unity-editor grep -qE "(Refresh completed|All packages resolved|Successfully imported|Begin MonoManager ReloadAssembly)" /project/Logs/unity.log 2>/dev/null; then
                echo "✓ Unity initialized!"
                break
              fi
              
              # Check for errors
              if docker exec unity-editor grep -qE "(Fatal error|License error)" /project/Logs/unity.log 2>/dev/null; then
                echo "✗ Unity error detected!"
                docker exec unity-editor tail -50 /project/Logs/unity.log
                exit 1
              fi
            fi
            
            sleep 5
            ELAPSED=$((ELAPSED + 5))
          done
      
      - name: Show Unity status
        run: |
          echo "=== Unity Process ==="
          docker exec unity-editor ps aux | grep Unity | grep -v grep || echo "Not running"
          echo ""
          echo "=== Unity Log (last 30 lines) ==="
          docker exec unity-editor tail -30 /project/Logs/unity.log 2>/dev/null || echo "No log yet"
      
      - name: Test MCP Server connectivity
        run: |
          echo "Testing MCP server..."
          curl -v http://localhost:8080/health || echo "MCP server not responding yet"
      
      - name: SUCCESS - Services remain alive
        run: |
          echo "=== Active Services ==="
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          echo ""
          echo "✓ Unity Editor is running in service container!"
          echo "✓ MCP Server is running in service container!"
          echo "✓ Both will remain active for subsequent jobs/steps"
          echo ""
          echo "Port mappings:"
          echo "  - Unity: localhost:7777"
          echo "  - MCP Server: localhost:8080"
      
      # Add more steps here - Unity and MCP will stay alive!
      - name: Example - Additional step
        run: |
          echo "Unity is still running in background..."
          docker exec unity-editor pgrep Unity || echo "Unity stopped!"