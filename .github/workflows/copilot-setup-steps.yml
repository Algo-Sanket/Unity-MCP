name: "Copilot Setup Steps"
on:
  workflow_dispatch:
  push:
    paths: [ .github/workflows/copilot-setup-steps.yml ]
  pull_request:
    paths: [ .github/workflows/copilot-setup-steps.yml ]

jobs:
  copilot-setup-steps:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 60
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Verify project structure
        run: |
          echo "=== Verifying Unity MCP Project Structure ==="
          
          if [ ! -d "Unity-MCP-Plugin" ]; then
            echo "âœ— ERROR: Unity-MCP-Plugin directory not found!"
            echo "Repository contents:"
            ls -la
            exit 1
          fi
          
          echo "âœ“ Unity-MCP-Plugin found"
          
          if [ ! -f "Unity-MCP-Plugin/Assets/root/package.json" ]; then
            echo "âœ— ERROR: package.json not found!"
            exit 1
          fi
          
          echo "âœ“ Package configuration found"
          echo ""
          cat Unity-MCP-Plugin/Assets/root/package.json | grep -E '"name"|"version"|"displayName"'
      
      - name: Setup MCP Server environment
        run: |
          echo "=== Setting up .NET environment ==="
          
          # Install .NET 9.0 SDK
          wget https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/packages-microsoft-prod.deb
          sudo dpkg -i packages-microsoft-prod.deb
          sudo apt-get update
          sudo apt-get install -y dotnet-sdk-9.0
          
          # Verify installation
          dotnet --version
          dotnet --list-sdks
          
          echo "âœ“ .NET 9.0 SDK installed"
      
      - name: Build MCP Server
        timeout-minutes: 15
        run: |
          echo "=== Building MCP Server ==="
          
          cd Unity-MCP-Server
          
          echo "Step 1: Restoring dependencies..."
          dotnet restore --timeout 120
          
          echo ""
          echo "Step 2: Building Release configuration..."
          dotnet build -c Release --timeout 120
          
          if [ $? -eq 0 ]; then
            echo "âœ“ MCP Server build successful"
          else
            echo "âœ— MCP Server build failed"
            exit 1
          fi
      
      - name: Build MCP Server for all platforms
        timeout-minutes: 20
        run: |
          echo "=== Building MCP Server for all platforms ==="
          
          cd Unity-MCP-Server
          
          if [ -f "build-all.sh" ]; then
            chmod +x build-all.sh
            echo "Running multi-platform build..."
            ./build-all.sh Release
            
            if [ $? -eq 0 ]; then
              echo "âœ“ Multi-platform build successful"
              
              echo ""
              echo "=== Build Output ==="
              find publish -type f -executable 2>/dev/null | head -20
            else
              echo "âœ— Multi-platform build failed"
              exit 1
            fi
          else
            echo "âš  build-all.sh not found, skipping multi-platform build"
          fi
      
      - name: Setup Docker
        run: |
          echo "=== Verifying Docker setup ==="
          
          docker --version
          
          if docker compose version &>/dev/null; then
            echo "âœ“ Docker Compose v2 available"
            docker compose version
          elif command -v docker-compose &>/dev/null; then
            echo "âœ“ Docker Compose v1 available"
            docker-compose version
          else
            echo "âœ— Docker Compose not found"
            exit 1
          fi
      
      - name: Create docker-compose configuration
        run: |
          echo "=== Creating docker-compose.yml ==="
          
          cat > docker-compose.yml << 'EOF'
          version: '3.8'
          
          services:
            unity-mcp-server:
              image: ivanmurzakdev/unity-mcp-server:latest
              container_name: unity-mcp-server
              ports:
                - "8080:8080"
              environment:
                UNITY_MCP_PORT: 8080
                UNITY_MCP_CLIENT_TRANSPORT: http
              networks:
                - unity-network
              healthcheck:
                test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
                interval: 10s
                timeout: 5s
                retries: 5
              restart: unless-stopped
            
            unity-editor:
              image: unityci/editor:ubuntu-6000.0.12f1-base-3
              container_name: unity-editor
              ports:
                - "7777:7777"
              shm_size: 2g
              networks:
                - unity-network
              volumes:
                - ./Unity-MCP-Plugin:/project
                - unity-logs:/project/Logs
              entrypoint: ["/bin/bash", "-c"]
              command:
                - |
                  set -e
                  echo "=== Unity Container Starting ==="
                  
                  # Create necessary directories
                  mkdir -p /root/.local/share/unity3d/Unity
                  mkdir -p /project/Logs
                  chmod 777 /project/Logs
                  
                  # Check if license file will be provided
                  if [ -f /root/.local/share/unity3d/Unity/Unity_lic.ulf ]; then
                    echo "âœ“ License file found"
                  else
                    echo "âš  No license file provided"
                    echo "IMPORTANT: Unity Personal License requires license file"
                    echo "To use this container, provide license file at:"
                    echo "  /root/.local/share/unity3d/Unity/Unity_lic.ulf"
                  fi
                  
                  # Wait for project files to be available
                  echo "Waiting for project files..."
                  TIMEOUT=60
                  ELAPSED=0
                  while [ ! -d /project/Assets ] && [ $ELAPSED -lt $TIMEOUT ]; do
                    echo "  Waiting... ($ELAPSED/$TIMEOUT)"
                    sleep 2
                    ELAPSED=$((ELAPSED + 2))
                  done
                  
                  if [ ! -d /project/Assets ]; then
                    echo "âš  Project Assets not found, creating minimal structure..."
                    mkdir -p /project/Assets /project/ProjectSettings
                  fi
                  
                  # Start Unity Editor
                  echo "Starting Unity Editor..."
                  /opt/unity/Editor/Unity \
                    -projectPath /project \
                    -batchmode \
                    -nographics \
                    -buildTarget StandaloneLinux64 \
                    -executeMethod com.IvanMurzak.Unity.MCP.Editor.Startup.Init \
                    -logFile /project/Logs/unity.log \
                    2>&1 &
                  
                  UNITY_PID=$!
                  echo "Unity started with PID: $UNITY_PID"
                  
                  # Keep container alive while monitoring Unity
                  while kill -0 $UNITY_PID 2>/dev/null; do
                    sleep 10
                  done
                  
                  echo "Unity process ended"
              healthcheck:
                test: ["CMD", "pgrep", "-f", "Unity"]
                interval: 10s
                timeout: 5s
                retries: 3
                start_period: 60s
              restart: unless-stopped
          
          volumes:
            unity-logs:
          
          networks:
            unity-network:
              driver: bridge
          EOF
          
          echo "âœ“ docker-compose.yml created successfully"
      
      - name: Start MCP Server
        timeout-minutes: 5
        run: |
          echo "=== Starting MCP Server ==="
          
          if docker compose version &>/dev/null; then
            COMPOSE_CMD="docker compose"
          else
            COMPOSE_CMD="docker-compose"
          fi
          
          # Start only MCP server
          $COMPOSE_CMD up -d unity-mcp-server
          
          echo "âœ“ MCP Server container started"
          echo ""
          $COMPOSE_CMD ps
      
      - name: Wait for MCP Server readiness
        timeout-minutes: 5
        run: |
          echo "=== Waiting for MCP Server to be ready ==="
          
          TIMEOUT=60
          ELAPSED=0
          
          while [ $ELAPSED -lt $TIMEOUT ]; do
            if curl -f http://localhost:8080/health 2>/dev/null; then
              echo "âœ“ MCP Server is ready!"
              
              # Get server info
              echo ""
              echo "MCP Server Status:"
              curl -s http://localhost:8080/health | head -20
              break
            fi
            
            echo "Waiting... ($ELAPSED/$TIMEOUT seconds)"
            sleep 5
            ELAPSED=$((ELAPSED + 5))
          done
          
          if [ $ELAPSED -ge $TIMEOUT ]; then
            echo "âœ— MCP Server failed to start within timeout"
            
            if docker compose version &>/dev/null; then
              docker compose logs unity-mcp-server
            else
              docker-compose logs unity-mcp-server
            fi
            
            exit 1
          fi
      
      - name: Start Unity Editor (without credentials)
        timeout-minutes: 5
        run: |
          echo "=== Starting Unity Editor Container ==="
          
          if docker compose version &>/dev/null; then
            COMPOSE_CMD="docker compose"
          else
            COMPOSE_CMD="docker-compose"
          fi
          
          # Start Unity editor container
          $COMPOSE_CMD up -d unity-editor
          
          echo "âœ“ Unity Editor container started"
          echo ""
          $COMPOSE_CMD ps
      
      - name: Wait for Unity initialization
        timeout-minutes: 10
        run: |
          echo "=== Waiting for Unity to initialize ==="
          
          TIMEOUT=300
          ELAPSED=0
          
          while [ $ELAPSED -lt $TIMEOUT ]; do
            # Check if Unity process is running
            if docker exec unity-editor pgrep -f "Unity" > /dev/null 2>&1; then
              echo "âœ“ Unity process is running"
              
              # Check log file for progress
              if docker exec unity-editor test -f /project/Logs/unity.log 2>/dev/null; then
                SIZE=$(docker exec unity-editor stat -c%s /project/Logs/unity.log 2>/dev/null || echo "0")
                
                if [ $SIZE -gt 100 ]; then
                  # Show last few lines periodically
                  if [ $((ELAPSED % 30)) -eq 0 ]; then
                    echo ""
                    echo "Recent log output:"
                    docker exec unity-editor tail -5 /project/Logs/unity.log 2>/dev/null
                  fi
                fi
              fi
            else
              echo "âš  Unity process not yet running ($ELAPSED/$TIMEOUT)"
            fi
            
            sleep 10
            ELAPSED=$((ELAPSED + 10))
          done
          
          echo ""
          echo "âœ“ Unity initialization wait completed"
      
      - name: Verify all services
        run: |
          echo "=== Verifying Services Status ==="
          echo ""
          
          if docker compose version &>/dev/null; then
            COMPOSE_CMD="docker compose"
          else
            COMPOSE_CMD="docker-compose"
          fi
          
          echo "Running containers:"
          $COMPOSE_CMD ps
          
          echo ""
          echo "=== MCP Server Health ==="
          if curl -f http://localhost:8080/health 2>/dev/null; then
            echo "âœ“ MCP Server: HEALTHY"
          else
            echo "âœ— MCP Server: UNHEALTHY"
          fi
          
          echo ""
          echo "=== Unity Editor Status ==="
          if docker exec unity-editor pgrep -f "Unity" > /dev/null 2>&1; then
            echo "âœ“ Unity: RUNNING"
          else
            echo "âš  Unity: NOT RUNNING"
          fi
          
          echo ""
          echo "=== Network Configuration ==="
          docker network inspect unity-network 2>/dev/null | grep -A 5 "Containers" || echo "Network not found"
      
      - name: Show service logs
        if: always()
        run: |
          echo "=== Service Logs ==="
          
          if docker compose version &>/dev/null; then
            COMPOSE_CMD="docker compose"
          else
            COMPOSE_CMD="docker-compose"
          fi
          
          echo ""
          echo "--- MCP Server Logs (last 30 lines) ---"
          $COMPOSE_CMD logs unity-mcp-server 2>/dev/null | tail -30
          
          echo ""
          echo "--- Unity Editor Logs ---"
          if [ -f "Unity-MCP-Plugin/Logs/unity.log" ]; then
            echo "Last 50 lines from unity.log:"
            tail -50 Unity-MCP-Plugin/Logs/unity.log
          else
            echo "unity.log not found locally, checking container..."
            docker exec unity-editor tail -50 /project/Logs/unity.log 2>/dev/null || echo "No log available"
          fi
      
      - name: Environment Ready - GitHub Copilot
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                                       â•‘"
          echo "â•‘  âœ“ UNITY MCP ENVIRONMENT READY FOR GITHUB COPILOT âœ“  â•‘"
          echo "â•‘                                                       â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Available Services:"
          echo "  ðŸŽ® Unity Editor:     localhost:7777"
          echo "  ðŸ”Œ MCP Server:       localhost:8080"
          echo "  ðŸŒ MCP Health:       http://localhost:8080/health"
          echo ""
          echo "Containers remain active for additional steps!"
          echo "GitHub Copilot can now interact with Unity via MCP Protocol."
          echo ""
      
      # ============================================
      # CUSTOM COPILOT STEPS - ADD BELOW
      # Services stay active throughout!
      # ============================================
      
      - name: Test MCP Server connectivity
        run: |
          echo "=== Testing MCP Server ==="
          
          echo "Endpoint: http://localhost:8080"
          curl -v http://localhost:8080/health 2>&1 | grep -E "HTTP|Connected"
          
          echo "âœ“ MCP Server is accessible"
      
      - name: Test Unity Editor connectivity
        run: |
          echo "=== Testing Unity Editor ==="
          
          if docker exec unity-editor pgrep -f "Unity" > /dev/null 2>&1; then
            echo "âœ“ Unity process is running"
            
            # List open ports
            docker exec unity-editor netstat -tuln 2>/dev/null | grep LISTEN || echo "netstat not available"
          else
            echo "âš  Unity process not running"
          fi
      
      # Add your custom Copilot steps here
      # Both MCP Server and Unity remain active
      
      - name: Cleanup (always runs)
        if: always()
        timeout-minutes: 5
        run: |
          echo "=== Cleaning up ==="
          
          if docker compose version &>/dev/null; then
            COMPOSE_CMD="docker compose"
          else
            COMPOSE_CMD="docker-compose"
          fi
          
          echo "Stopping containers..."
          $COMPOSE_CMD down -v 2>/dev/null || true
          
          echo "âœ“ Cleanup completed"