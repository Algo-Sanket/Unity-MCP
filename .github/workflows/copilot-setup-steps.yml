name: Copilot + Unity MCP Setup

on:
  workflow_dispatch:
  push:
    paths: [.github/workflows/copilot-setup-steps.yml]
  pull_request:
    paths: [.github/workflows/copilot-setup-steps.yml]

jobs:
  unity-mcp:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc "/usr/local/share/boost" "$AGENT_TOOLSDIRECTORY" || true

      - name: Validate Unity credentials
        env:
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        run: |
          if [[ -z "$UNITY_EMAIL" || -z "$UNITY_PASSWORD" ]]; then
            echo "ERROR: Missing UNITY_EMAIL or UNITY_PASSWORD secrets!"
            echo "Add them in: Settings → Secrets and variables → Actions"
            exit 1
          fi
          echo "Unity credentials validated"

      - name: Create docker-compose.yml
        env:
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        run: |
          cat > docker-compose.yml << EOF
          services:
            unity-mcp-server:
              image: ivanmurzakdev/unity-mcp-server:latest
              container_name: unity-mcp-server
              ports:
                - "8080:8080"
              environment:
                UNITY_MCP_PORT: 8080
                UNITY_MCP_CLIENT_TRANSPORT: http
                UNITY_EMAIL: ${UNITY_EMAIL}
                UNITY_PASSWORD: ${UNITY_PASSWORD}
              networks:
                - unity-net
              healthcheck:
                test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
                interval: 8s
                timeout: 5s
                retries: 40
                start_period: 10s
              restart: unless-stopped

            unity-editor:
              image: unityci/editor:ubuntu-6000.0.12f1-base-3
              container_name: unity-editor
              ports:
                - "7777:7777"
              shm_size: 4g
              environment:
                UNITY_EMAIL: ${UNITY_EMAIL}
                UNITY_PASSWORD: ${UNITY_PASSWORD}
              volumes:
                - ./Unity-MCP-Plugin:/project
                - unity-logs:/project/Logs
              networks:
                - unity-net
              entrypoint: ["/bin/bash", "-c"]
              command: |
                set -e
                echo "Returning old license..."
                /opt/unity/Editor/Unity -batchmode -nographics -quit -returnlicense || true

                echo "Activating Personal license via login..."
                /opt/unity/Editor/Unity \\
                  -batchmode -nographics -quit \\
                  -username "\${UNITY_EMAIL}" \\
                  -password "\${UNITY_PASSWORD}" \\
                  -logFile /tmp/license.log

                mkdir -p /project/{Assets,ProjectSettings,Logs}
                chmod 777 /project/Logs

                echo "Starting Unity with MCP plugin..."
                exec /opt/unity/Editor/Unity \\
                  -projectPath /project \\
                  -batchmode \\
                  -nographics \\
                  -executeMethod com.IvanMurzak.Unity.MCP.Editor.Startup.Init \\
                  -logFile /project/Logs/unity.log

          volumes:
            unity-logs:

          networks:
            unity-net:
              driver: bridge
          EOF
          echo "docker-compose.yml created"

      - name: Start containers
        run: |
          docker compose up -d
          docker compose ps

      - name: Wait for MCP Server (robust)
        run: |
          echo "Waiting for MCP Server to be healthy..."
          for i in {1..60}; do
            if curl -f http://localhost:8080/health >/dev/null 2>&1; then
              echo "MCP Server is READY!"
              curl http://localhost:8080/health
              break
            fi
            echo "Attempt $i/60... sleeping 5s"
            sleep 5
          done

          curl -f http://localhost:8080/health || {
            echo "MCP Server failed!"
            docker compose logs unity-mcp-server
            exit 1
          }

      - name: Wait for Unity Editor
        run: |
          echo "Waiting for Unity process to start..."
          for i in {1..70}; do
            if docker exec unity-editor pgrep -f Unity >/dev/null 2>&1; then
              echo "Unity Editor is RUNNING!"
              break
            fi
            echo "Waiting... ($i/70)"
            sleep 6
          done

          docker compose ps

      - name: Environment Ready!
        run: |
          echo ""
          echo "╔══════════════════════════════════════════════════╗"
          echo "║      COPILOT + UNITY ENVIRONMENT IS READY!      ║"
          echo "║                                                  ║"
          echo "║   Unity Editor : http://localhost:7777           ║"
          echo "║   MCP Server   : http://localhost:8080            ║"
          echo "║                                                  ║"
          echo "║   GitHub Copilot can now edit your project!     ║"
          echo "╚══════════════════════════════════════════════════╝"
          echo ""

      - name: Test MCP Connection
        run: |
          curl -X POST http://localhost:8080/v1/messages \
            -H "Content-Type: application/json" \
            -d '{"messages":[{"role":"user","content":"Hello from GitHub Actions – $(date)"}]}' \
            -s | jq .

      # Add all your Copilot automation steps here ↓

      - name: Cleanup
        if: always()
        run: |
          echo "Shutting down..."
          docker compose down -v || true
          echo "Done!"