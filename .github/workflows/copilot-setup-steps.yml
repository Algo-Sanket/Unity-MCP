name: "Copilot Setup Steps"
on:
  workflow_dispatch:
  push:
    paths: [ .github/workflows/copilot-setup-steps.yml ]
  pull_request:
    paths: [ .github/workflows/copilot-setup-steps.yml ]

jobs:
  copilot-setup-steps:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Docker Compose
        run: |
          # Check if docker compose (v2) is available
          if docker compose version &>/dev/null; then
            echo "âœ“ Docker Compose v2 already available"
            docker compose version
          elif command -v docker-compose &>/dev/null; then
            echo "âœ“ Docker Compose v1 found"
            docker-compose version
            echo "Creating alias for compatibility..."
            # We'll use docker-compose v1 syntax throughout
          else
            echo "Installing Docker Compose..."
            sudo curl -L "https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
            docker-compose version
          fi
      
      - name: Create docker-compose.yml
        run: |
          cat > docker-compose.yml << 'EOF'
          version: '3.8'
          
          services:
            unity-mcp-server:
              image: ivanmurzakdev/unity-mcp-server:latest
              container_name: unity-mcp-server
              ports:
                - "8080:8080"
              environment:
                UNITY_MCP_PORT: 8080
                UNITY_MCP_CLIENT_TRANSPORT: http
              networks:
                - unity-network
              healthcheck:
                test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
                interval: 10s
                timeout: 5s
                retries: 5
            
            unity-editor:
              image: unityci/editor:ubuntu-6000.0.12f1-base-3
              container_name: unity-editor
              ports:
                - "7777:7777"
              shm_size: 2g
              networks:
                - unity-network
              volumes:
                - ./Unity-MCP-Plugin:/project
                - unity-logs:/project/Logs
              environment:
                UNITY_EMAIL: ${UNITY_EMAIL}
                UNITY_PASSWORD: ${UNITY_PASSWORD}
              entrypoint: ["/bin/bash", "-c"]
              command:
                - |
                  set -e
                  echo "=== Unity Container Starting ==="
                  
                  # Create license directory
                  mkdir -p /root/.local/share/unity3d/Unity
                  
                  # Activate Unity license with proper parameters
                  echo "Activating Unity license..."
                  /opt/unity/Editor/Unity \
                    -batchmode \
                    -nographics \
                    -quit \
                    -logFile /tmp/activation.log \
                    -username "${UNITY_EMAIL}" \
                    -password "${UNITY_PASSWORD}" || true
                  
                  # Wait longer for activation to complete
                  echo "Waiting for license activation..."
                  sleep 10
                  
                  # Check license activation with better logging
                  if [ -f /root/.local/share/unity3d/Unity/Unity_lic.ulf ]; then
                    echo "âœ“ License activated successfully!"
                    echo "License file info:"
                    ls -lh /root/.local/share/unity3d/Unity/Unity_lic.ulf
                  else
                    echo "âœ— License activation failed!"
                    echo ""
                    echo "=== Activation Log ==="
                    cat /tmp/activation.log 2>/dev/null || echo "No activation log"
                    echo ""
                    echo "=== License Directory Contents ==="
                    ls -la /root/.local/share/unity3d/Unity/ 2>/dev/null || echo "Directory doesn't exist"
                    echo ""
                    echo "Attempting to continue anyway - Unity might activate on first run..."
                  fi
                  
                  # Wait for project files
                  echo "Waiting for project files..."
                  TIMEOUT=60
                  ELAPSED=0
                  while [ ! -d /project/Assets ] && [ $ELAPSED -lt $TIMEOUT ]; do
                    echo "Waiting... ($ELAPSED/$TIMEOUT)"
                    sleep 2
                    ELAPSED=$((ELAPSED + 2))
                  done
                  
                  if [ ! -d /project/Assets ]; then
                    echo "âš  Project Assets not found, creating minimal project structure..."
                    mkdir -p /project/Assets /project/ProjectSettings
                  fi
                  
                  # Create logs directory
                  mkdir -p /project/Logs
                  chmod 777 /project/Logs
                  
                  # Start Unity Editor - this will also attempt activation if needed
                  echo "Starting Unity Editor..."
                  /opt/unity/Editor/Unity \
                    -projectPath /project \
                    -batchmode \
                    -nographics \
                    -username "${UNITY_EMAIL}" \
                    -password "${UNITY_PASSWORD}" \
                    -executeMethod com.IvanMurzak.Unity.MCP.Editor.Startup.Init \
                    -logFile /project/Logs/unity.log \
                    2>&1 | tee /project/Logs/unity-stdout.log &
                  
                  UNITY_PID=$!
                  echo "Unity started with PID: $UNITY_PID"
                  echo $UNITY_PID > /tmp/unity.pid
                  
                  # Keep container alive and monitor Unity
                  echo "Container staying alive, monitoring Unity..."
                  while true; do
                    if ! kill -0 $UNITY_PID 2>/dev/null; then
                      echo "âš  Unity process died, checking logs..."
                      
                      # Check if it was a license issue
                      if grep -qi "license" /project/Logs/unity.log 2>/dev/null; then
                        echo "License issue detected, attempting reactivation..."
                        /opt/unity/Editor/Unity \
                          -batchmode \
                          -nographics \
                          -quit \
                          -username "${UNITY_EMAIL}" \
                          -password "${UNITY_PASSWORD}" \
                          -logFile /tmp/reactivation.log || true
                        sleep 5
                      fi
                      
                      echo "Restarting Unity..."
                      /opt/unity/Editor/Unity \
                        -projectPath /project \
                        -batchmode \
                        -nographics \
                        -username "${UNITY_EMAIL}" \
                        -password "${UNITY_PASSWORD}" \
                        -executeMethod com.IvanMurzak.Unity.MCP.Editor.Startup.Init \
                        -logFile /project/Logs/unity.log \
                        2>&1 | tee /project/Logs/unity-stdout.log &
                      UNITY_PID=$!
                      echo $UNITY_PID > /tmp/unity.pid
                    fi
                    sleep 30
                  done
              healthcheck:
                test: ["CMD", "pgrep", "-f", "Unity"]
                interval: 10s
                timeout: 5s
                retries: 3
                start_period: 60s
          
          volumes:
            unity-logs:
          
          networks:
            unity-network:
              driver: bridge
          EOF
          
          echo "âœ“ docker-compose.yml created"
      
      - name: Verify project structure
        run: |
          echo "Checking project structure..."
          if [ -d "Unity-MCP-Plugin" ]; then
            echo "âœ“ Unity-MCP-Plugin found"
            ls -la Unity-MCP-Plugin/
          else
            echo "âœ— Unity-MCP-Plugin not found!"
            echo "Repository contents:"
            ls -la
            exit 1
          fi
      
      - name: Start services with docker-compose
        env:
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        run: |
          echo "Starting services with docker compose..."
          
          # Check credentials
          if [ -z "$UNITY_EMAIL" ] || [ -z "$UNITY_PASSWORD" ]; then
            echo "âœ— UNITY_EMAIL or UNITY_PASSWORD not set!"
            echo "Please add these secrets in repository settings:"
            echo "  1. Go to Settings â†’ Secrets and variables â†’ Actions"
            echo "  2. Add UNITY_EMAIL with your Unity account email"
            echo "  3. Add UNITY_PASSWORD with your Unity account password"
            exit 1
          fi
          
          # Determine which docker compose command to use
          if docker compose version &>/dev/null; then
            COMPOSE_CMD="docker compose"
          else
            COMPOSE_CMD="docker-compose"
          fi
          
          echo "Using: $COMPOSE_CMD"
          
          # Start services in detached mode
          $COMPOSE_CMD up -d
          
          echo "âœ“ Services started"
          echo ""
          $COMPOSE_CMD ps
      
      - name: Wait for MCP Server
        run: |
          echo "Waiting for MCP Server to be ready..."
          TIMEOUT=60
          ELAPSED=0
          
          while [ $ELAPSED -lt $TIMEOUT ]; do
            if curl -f http://localhost:8080/health 2>/dev/null; then
              echo "âœ“ MCP Server is ready!"
              break
            fi
            echo "Waiting... ($ELAPSED/$TIMEOUT)"
            sleep 5
            ELAPSED=$((ELAPSED + 5))
          done
          
          if [ $ELAPSED -ge $TIMEOUT ]; then
            echo "âœ— MCP Server failed to start"
            docker-compose logs unity-mcp-server
            exit 1
          fi
      
      - name: Wait for Unity initialization
        run: |
          echo "Waiting for Unity to initialize..."
          TIMEOUT=300
          ELAPSED=0
          
          while [ $ELAPSED -lt $TIMEOUT ]; do
            # Check if Unity process is running
            if ! docker exec unity-editor pgrep -f "Unity" > /dev/null 2>&1; then
              echo "âš  Unity not running yet... ($ELAPSED/$TIMEOUT)"
            else
              echo "âœ“ Unity process is running!"
              
              # Check if log file exists and has content
              if docker exec unity-editor test -f /project/Logs/unity.log 2>/dev/null; then
                SIZE=$(docker exec unity-editor stat -c%s /project/Logs/unity.log 2>/dev/null || echo "0")
                
                if [ $SIZE -gt 100 ]; then
                  # Check for successful initialization
                  if docker exec unity-editor grep -qE "(Refresh completed|All packages resolved|Successfully imported|Compilation finished)" /project/Logs/unity.log 2>/dev/null; then
                    echo "âœ“ Unity initialized successfully!"
                    break
                  fi
                  
                  # Check for errors
                  if docker exec unity-editor grep -qiE "(license.*error|Fatal error)" /project/Logs/unity.log 2>/dev/null; then
                    echo "âœ— Unity error detected!"
                    docker exec unity-editor tail -50 /project/Logs/unity.log
                    exit 1
                  fi
                  
                  # Show progress
                  if [ $((ELAPSED % 30)) -eq 0 ]; then
                    echo "Still initializing... ($ELAPSED/$TIMEOUT)"
                    docker exec unity-editor tail -10 /project/Logs/unity.log 2>/dev/null || echo "No log yet"
                  fi
                fi
              fi
            fi
            
            sleep 5
            ELAPSED=$((ELAPSED + 5))
          done
          
          if [ $ELAPSED -ge $TIMEOUT ]; then
            echo "âš  Timeout reached, but continuing..."
            docker exec unity-editor tail -50 /project/Logs/unity.log 2>/dev/null || echo "No log"
          fi
      
      - name: Verify services are running
        run: |
          # Determine which docker compose command to use
          if docker compose version &>/dev/null; then
            COMPOSE_CMD="docker compose"
          else
            COMPOSE_CMD="docker-compose"
          fi
          
          echo "=== Service Status ==="
          echo ""
          $COMPOSE_CMD ps
          echo ""
          
          echo "=== MCP Server Health ==="
          curl -f http://localhost:8080/health 2>/dev/null && echo "âœ“ MCP Server: OK" || echo "âœ— MCP Server: FAIL"
          
          echo ""
          echo "=== Unity Process ==="
          if docker exec unity-editor pgrep -f Unity > /dev/null 2>&1; then
            echo "âœ“ Unity: RUNNING"
            docker exec unity-editor ps aux | grep Unity | grep -v grep
          else
            echo "âœ— Unity: NOT RUNNING"
            $COMPOSE_CMD logs unity-editor | tail -50
          fi
          
          echo ""
          echo "=== Unity Port Check ==="
          nc -zv localhost 7777 2>&1 | grep -q succeeded && echo "âœ“ Port 7777: OPEN" || echo "âš  Port 7777: CLOSED"
      
      - name: Show Unity logs
        if: always()
        run: |
          echo "=== Unity Logs (last 100 lines) ==="
          docker exec unity-editor tail -100 /project/Logs/unity.log 2>/dev/null || echo "No Unity log available"
          
          echo ""
          echo "=== Unity StdOut ==="
          docker exec unity-editor tail -50 /project/Logs/unity-stdout.log 2>/dev/null || echo "No stdout log"
      
      - name: SUCCESS - Environment Ready!
        run: |
          # Determine which docker compose command to use
          if docker compose version &>/dev/null; then
            COMPOSE_CMD="docker compose"
          else
            COMPOSE_CMD="docker-compose"
          fi
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘    âœ“ COPILOT ENVIRONMENT READY! âœ“     â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Services running in background:"
          echo "  ðŸŽ® Unity Editor:  localhost:7777"
          echo "  ðŸ”Œ MCP Server:    localhost:8080"
          echo ""
          echo "Containers will stay alive for all remaining steps!"
          echo "GitHub Copilot can now interact with Unity via MCP."
          echo ""
          $COMPOSE_CMD ps
      
      # ============================================
      # ADD YOUR COPILOT STEPS BELOW
      # Unity stays alive throughout!
      # ============================================
      
      - name: Example - Test Unity Interaction
        run: |
          echo "Testing if Unity is still responsive..."
          
          # Check Unity process
          if docker exec unity-editor pgrep -f Unity > /dev/null 2>&1; then
            echo "âœ“ Unity is still running!"
          else
            echo "âœ— Unity stopped!"
            exit 1
          fi
          
          # You can add MCP commands here
          echo "âœ“ Unity is ready for Copilot commands!"
      
      - name: Example - Query Unity via MCP
        run: |
          echo "Example: Querying MCP Server..."
          curl -f http://localhost:8080/health && echo "âœ“ MCP responding" || echo "âœ— MCP not responding"
      
      # Add more steps here - Unity containers stay alive!
      
      - name: Cleanup (runs even if previous steps fail)
        if: always()
        run: |
          # Determine which docker compose command to use
          if docker compose version &>/dev/null; then
            COMPOSE_CMD="docker compose"
          else
            COMPOSE_CMD="docker-compose"
          fi
          
          echo "Shutting down services..."
          $COMPOSE_CMD down -v || echo "Cleanup completed with warnings"
          echo "âœ“ Cleanup complete"