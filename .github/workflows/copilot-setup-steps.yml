name: "Copilot + Unity Personal (Working 2025)"

on:
  workflow_dispatch:
  push:
    paths: [ ".github/workflows/copilot-unity.yml" ]
  pull_request:
    paths: [ ".github/workflows/copilot-unity.yml" ]

# Critical: Only ONE job at a time can hold the Personal license
concurrency:
  group: unity-personal-copilot-${{ github.ref }}
  cancel-in-progress: true

jobs:
  copilot-unity:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true

      # Proper Unity Personal activation (official method)
      - name: Activate Unity License (Personal)
        uses: game-ci/unity-actf-licensing@v2
        env:
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}

      # Start your services using the official, working way
      - name: Start Unity MCP Server + Editor
        run: |
          docker network create unity-network || true

          # MCP Server
          docker run -d \
            --name unity-mcp-server \
            --network unity-network \
            -p 8080:8080 \
            ivanmurzakdev/unity-mcp-server:latest

          # Unity Editor with proper license + volume mount
          docker run -d \
            --name unity-editor \
            --network unity-network \
            -p 7777:7777 \
            -v "$(pwd)/Unity-MCP-Plugin:/project" \
            -v unity-logs:/project/Logs \
            --shm-size=2g \
            unityci/editor:ubuntu-2022.3.61f1-base-3 \
            /bin/bash -c "
              mkdir -p /project/Logs && chmod 777 /project/Logs &&
              /opt/unity/Editor/Unity \
                -batchmode \
                -nographics \
                -projectPath /project \
                -executeMethod com.IvanMurzak.Unity.MCP.Editor.Startup.Init \
                -logFile /project/Logs/unity.log
            "

      # Wait for MCP Server
      - name: Wait for MCP Server
        run: |
          timeout=60
          while [ $timeout -gt 0 ]; do
            if curl -f http://localhost:8080/health >/dev/null 2>&1; then
              echo "MCP Server is ready!"
              break
            fi
            echo "Waiting for MCP Server... ($timeout)"
            sleep 5
            timeout=$((timeout-5))
          done
          curl http://localhost:8080/health

      # Wait for Unity to initialize
      - name: Wait for Unity Editor
        run: |
          echo "Waiting for Unity to start..."
          sleep 30
          docker logs unity-editor --tail 50

      # Show status
      - name: Status Check
        run: |
          echo "All services running!"
          echo "Unity Editor → localhost:7777"
          echo "MCP Server   → localhost:8080"
          docker ps

      # Your Copilot steps go here — Unity stays alive!
      - name: Test MCP Connection
        run: |
          curl -X POST http://localhost:8080/api/ping \
            -H "Content-Type: application/json" \
            -d '{}'

      # Always return the license at the end
      - name: Return Unity License
        if: always()
        uses: game-ci/unity-actf-licensing@v2
        env:
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          returnLicense: true

      # Cleanup containers
      - name: Cleanup
        if: always()
        run: |
          docker rm -f unity-mcp-server unity-editor || true
          docker network rm unity-network || true
          docker volume rm unity-logs || true