name: "Copilot Setup Steps"
on:
  workflow_dispatch:
  push:
    paths: [ .github/workflows/copilot-setup-steps.yml ]
  pull_request:
    paths: [ .github/workflows/copilot-setup-steps.yml ]

jobs:
  copilot-setup-steps:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    # MCP Server as a service
    services:
      unity-mcp-server:
        image: ivanmurzakdev/unity-mcp-server:latest
        ports:
          - 8080:8080
        env:
          UNITY_MCP_PORT: 8080
          UNITY_MCP_CLIENT_TRANSPORT: http
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Create Unity Docker container
        run: |
          # Unity 6000.0.12f1 - matching your Unity version
          docker create --name unity-editor \
            -p 7777:7777 \
            --shm-size=2g \
            unityci/editor:ubuntu-6000.0.12f1-base-3 \
            tail -f /dev/null
          
          docker start unity-editor
          echo "âœ“ Unity container created and started"
      
      - name: Setup Unity Personal License
        run: |
          echo "Setting up Unity Personal License..."
          
          # Create license directory
          docker exec unity-editor mkdir -p /root/.local/share/unity3d/Unity
          
          # Write license file from GitHub secret
          docker exec unity-editor bash -c 'cat > /root/.local/share/unity3d/Unity/Unity_v2022.x.ulf << '"'"'LICENSEEOF'"'"'
          ${{ secrets.UNITY_LICENSE }}
          LICENSEEOF'
          
          # Verify license file was created
          if docker exec unity-editor test -f /root/.local/share/unity3d/Unity/Unity_v2022.x.ulf; then
            echo "âœ“ License file created successfully"
            docker exec unity-editor ls -lh /root/.local/share/unity3d/Unity/Unity_v2022.x.ulf
          else
            echo "âœ— Failed to create license file!"
            exit 1
          fi
      
      - name: Copy project to container
        run: |
          echo "Copying project files..."
          
          # Check if Unity-MCP-Plugin exists
          if [ -d "${{ github.workspace }}/Unity-MCP-Plugin" ]; then
            docker cp ${{ github.workspace }}/Unity-MCP-Plugin unity-editor:/project
          else
            echo "âœ— Unity-MCP-Plugin folder not found!"
            echo "Available folders:"
            ls -la ${{ github.workspace }}/
            exit 1
          fi
          
          # Verify project was copied
          docker exec unity-editor ls -la /project/
          echo "âœ“ Project copied successfully"
      
      - name: Prepare Unity environment
        run: |
          # Create log directory with proper permissions
          docker exec unity-editor mkdir -p /project/Logs
          docker exec unity-editor chmod 777 /project/Logs
          
          # Create launch script using a different approach
          cat > launch-unity.sh << 'SCRIPT_END'
          #!/bin/bash
          set -x
          echo "=== Unity Launch Script ==="
          echo "Timestamp: $(date)"
          echo "Project path: /project"
          echo "License file:"
          ls -lh /root/.local/share/unity3d/Unity/*.ulf 2>&1
          
          echo "Project contents:"
          ls -la /project/ 2>&1
          
          echo "Starting Unity Editor..."
          /opt/unity/Editor/Unity \
            -projectPath /project \
            -batchmode \
            -nographics \
            -executeMethod com.IvanMurzak.Unity.MCP.Editor.Startup.Init \
            -logFile /project/Logs/unity.log \
            2>&1 | tee /project/Logs/unity-stdout.log
          
          EXIT_CODE=$?
          echo "Unity exited with code: $EXIT_CODE"
          exit $EXIT_CODE
          SCRIPT_END
          
          # Copy script to container
          docker cp launch-unity.sh unity-editor:/tmp/launch-unity.sh
          docker exec unity-editor chmod +x /tmp/launch-unity.sh
          rm launch-unity.sh
          
          echo "âœ“ Unity environment prepared"
      
      - name: Launch Unity Editor
        run: |
          echo "Launching Unity in background..."
          docker exec -d unity-editor bash -c '/tmp/launch-unity.sh > /project/Logs/launch.log 2>&1 &'
          
          echo "Waiting 10 seconds for Unity to start..."
          sleep 10
          echo "âœ“ Unity launch initiated"
      
      - name: Verify Unity is running
        run: |
          echo "Checking Unity process..."
          
          if docker exec unity-editor pgrep -f "Unity" > /dev/null; then
            echo "âœ“ Unity process is running!"
            echo ""
            echo "=== Unity Process Info ==="
            docker exec unity-editor ps aux | grep Unity | grep -v grep
          else
            echo "âœ— Unity process NOT found!"
            echo ""
            echo "=== Launch Log ==="
            docker exec unity-editor cat /project/Logs/launch.log 2>/dev/null || echo "No launch log found"
            echo ""
            echo "=== All Container Processes ==="
            docker exec unity-editor ps aux
            echo ""
            echo "=== License File Check ==="
            docker exec unity-editor ls -la /root/.local/share/unity3d/Unity/ 2>/dev/null || echo "No license directory"
            exit 1
          fi
      
      - name: Monitor Unity initialization
        run: |
          echo "Monitoring Unity initialization..."
          TIMEOUT=300
          ELAPSED=0
          INITIALIZED=false
          
          while [ $ELAPSED -lt $TIMEOUT ]; do
            # Check if Unity process is still alive
            if ! docker exec unity-editor pgrep -f "Unity" > /dev/null; then
              echo "âœ— Unity process stopped unexpectedly!"
              echo ""
              echo "=== Unity Log ==="
              docker exec unity-editor cat /project/Logs/unity.log 2>/dev/null || echo "No log file"
              echo ""
              echo "=== StdOut Log ==="
              docker exec unity-editor cat /project/Logs/unity-stdout.log 2>/dev/null || echo "No stdout log"
              exit 1
            fi
            
            # Check if log file exists and has content
            if docker exec unity-editor test -f /project/Logs/unity.log; then
              SIZE=$(docker exec unity-editor stat -c%s /project/Logs/unity.log 2>/dev/null || echo "0")
              
              if [ $SIZE -gt 100 ]; then
                # Show progress every 30 seconds
                if [ $((ELAPSED % 30)) -eq 0 ]; then
                  echo ""
                  echo "=== Unity Status (${ELAPSED}s elapsed, log: ${SIZE} bytes) ==="
                  docker exec unity-editor tail -15 /project/Logs/unity.log
                  echo "==="
                fi
                
                # Check for successful initialization
                if docker exec unity-editor grep -qE "(Refresh completed|All packages resolved|Successfully imported|Compilation finished|Begin MonoManager ReloadAssembly)" /project/Logs/unity.log; then
                  echo ""
                  echo "âœ“ Unity initialized successfully!"
                  INITIALIZED=true
                  break
                fi
                
                # Check for license errors
                if docker exec unity-editor grep -qiE "(license.*error|license.*invalid|activation.*failed)" /project/Logs/unity.log; then
                  echo ""
                  echo "âœ— License error detected!"
                  echo "=== Unity Log ==="
                  docker exec unity-editor cat /project/Logs/unity.log
                  exit 1
                fi
                
                # Check for other fatal errors
                if docker exec unity-editor grep -qE "(Fatal error|Could not initialize|Aborting batchmode)" /project/Logs/unity.log; then
                  echo ""
                  echo "âœ— Fatal error detected!"
                  echo "=== Unity Log ==="
                  docker exec unity-editor tail -100 /project/Logs/unity.log
                  exit 1
                fi
              else
                echo "Waiting for log content... (${ELAPSED}s elapsed, size: ${SIZE} bytes)"
              fi
            else
              echo "Waiting for log file creation... (${ELAPSED}s elapsed)"
            fi
            
            sleep 5
            ELAPSED=$((ELAPSED + 5))
          done
          
          if [ "$INITIALIZED" = false ]; then
            echo ""
            echo "âš  Timeout reached without confirmation of initialization"
            echo "=== Final Unity Log ==="
            docker exec unity-editor cat /project/Logs/unity.log 2>/dev/null || echo "No log file"
            # Don't exit 1 here - Unity might still be working
          fi
      
      - name: Show Unity status
        run: |
          echo "=== Unity Process Status ==="
          docker exec unity-editor ps aux | grep Unity | grep -v grep || echo "Unity not running"
          
          echo ""
          echo "=== Unity Log (last 50 lines) ==="
          docker exec unity-editor tail -50 /project/Logs/unity.log 2>/dev/null || echo "No log file yet"
          
          echo ""
          echo "=== Running Containers ==="
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
      
      - name: Test services
        run: |
          echo "=== Service Health Checks ==="
          echo ""
          echo "MCP Server (port 8080):"
          curl -f http://localhost:8080/health 2>/dev/null && echo "âœ“ MCP Server responding" || echo "âœ— MCP Server not responding"
          
          echo ""
          echo "Unity port 7777:"
          nc -zv localhost 7777 2>&1 | grep -q succeeded && echo "âœ“ Port 7777 is open" || echo "âœ— Port 7777 not accessible"
      
      - name: SUCCESS - Containers alive!
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘         âœ“ SETUP COMPLETE âœ“            â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Services running:"
          echo "  ğŸ® Unity Editor:  localhost:7777"
          echo "  ğŸ”Œ MCP Server:    localhost:8080"
          echo ""
          echo "Unity will remain active for all subsequent steps!"
          echo "Add more steps below to interact with Unity."
          echo ""
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Image}}"